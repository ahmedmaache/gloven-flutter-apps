name: ðŸ”¨ Build Single App (Debug Mode)

on:
  workflow_dispatch:
    inputs:
      app_number:
        description: 'App number (01-100)'
        required: true
        default: '01'
        type: string

jobs:
  build-single-app:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“ Display build info
        run: |
          echo "## ðŸ”¨ Building Single App" >> $GITHUB_STEP_SUMMARY
          echo "**App Number**: ${{ github.event.inputs.app_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Package**: org.gloven.app${{ github.event.inputs.app_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          APP_NUM=$(printf "%02d" ${{ github.event.inputs.app_number }})
          APP_DIR="apps/app${APP_NUM}"
          echo "Building: $APP_DIR"
          echo "APP_DIR=$APP_DIR" >> $GITHUB_ENV

      - name: â˜• Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ“± Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.5'
          channel: 'stable'
          cache: true

      - name: ðŸ©º Flutter doctor
        run: |
          flutter doctor -v
          echo ""
          echo "Flutter version:"
          flutter --version

      - name: ðŸ“¦ Install dependencies
        run: |
          APP_NUM=$(printf "%02d" ${{ github.event.inputs.app_number }})
          APP_DIR="apps/app${APP_NUM}"
          echo "Installing dependencies for: $APP_DIR"
          
          if [ ! -d "$APP_DIR" ]; then
            echo "âŒ Error: Directory $APP_DIR does not exist"
            exit 1
          fi
          
          cd "$APP_DIR"
          echo "Current directory: $(pwd)"
          echo "Listing files:"
          ls -la
          
          if [ ! -f "pubspec.yaml" ]; then
            echo "âŒ Error: pubspec.yaml not found in $APP_DIR"
            exit 1
          fi
          
          echo "Running flutter pub get..."
          flutter pub get

      - name: ðŸ” Setup Android signing
        run: |
          APP_NUM=$(printf "%02d" ${{ github.event.inputs.app_number }})
          APP_DIR="apps/app${APP_NUM}"
          echo "Setting up signing for: $APP_DIR"
          
          # Check if secrets are available
          if [ -z "${{ secrets.KEYSTORE_BASE64 }}" ]; then
            echo "âŒ Error: KEYSTORE_BASE64 secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.KEYSTORE_PASSWORD }}" ]; then
            echo "âŒ Error: KEYSTORE_PASSWORD secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.KEY_PASSWORD }}" ]; then
            echo "âŒ Error: KEY_PASSWORD secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.KEY_ALIAS }}" ]; then
            echo "âŒ Error: KEY_ALIAS secret is not set"
            exit 1
          fi
          
          # Ensure android directory exists
          mkdir -p "$APP_DIR/android"
          
          # Decode base64 keystore from secret
          echo "Decoding keystore..."
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > "$APP_DIR/android/gloven-keystore.jks"
          chmod 600 "$APP_DIR/android/gloven-keystore.jks"
          
          # Create key.properties in android/ directory
          echo "Creating key.properties..."
          cat > "$APP_DIR/android/key.properties" << EOF
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=gloven-keystore.jks
          EOF
          
          # Verify keystore file
          echo "âœ… Verifying keystore..."
          if [ -f "$APP_DIR/android/gloven-keystore.jks" ]; then
            echo "âœ… Keystore file created: $APP_DIR/android/gloven-keystore.jks"
            ls -lh "$APP_DIR/android/gloven-keystore.jks"
            file "$APP_DIR/android/gloven-keystore.jks"
          else
            echo "âŒ Error: Keystore file not found"
            exit 1
          fi
          
          # Verify key.properties file
          echo "âœ… Verifying key.properties..."
          if [ -f "$APP_DIR/android/key.properties" ]; then
            echo "âœ… key.properties created: $APP_DIR/android/key.properties"
            echo "Contents (passwords masked):"
            cat "$APP_DIR/android/key.properties" | sed 's/password=.*/password=***/'
            echo ""
            echo "Full path: $(realpath "$APP_DIR/android/key.properties")"
          else
            echo "âŒ Error: key.properties not found"
            exit 1
          fi
          
          # Check build.gradle.kts configuration
          echo "âœ… Checking build.gradle.kts..."
          if [ -f "$APP_DIR/android/app/build.gradle.kts" ]; then
            echo "âœ… build.gradle.kts exists"
            if grep -q 'rootProject.file("key.properties")' "$APP_DIR/android/app/build.gradle.kts"; then
              echo "âœ… build.gradle.kts references key.properties correctly"
            else
              echo "âš ï¸  Warning: build.gradle.kts may not reference key.properties"
            fi
            
            # Check for signingConfigs
            echo "Checking signingConfigs block..."
            if grep -q 'signingConfigs' "$APP_DIR/android/app/build.gradle.kts"; then
              echo "âœ… signingConfigs block found"
              echo "SigningConfigs count:"
              grep -c 'signingConfigs {' "$APP_DIR/android/app/build.gradle.kts" || echo "0"
            else
              echo "âš ï¸  Warning: No signingConfigs block found"
            fi
          else
            echo "âŒ Error: build.gradle.kts not found"
            exit 1
          fi

      - name: ðŸ§¹ Clean build
        run: |
          APP_NUM=$(printf "%02d" ${{ github.event.inputs.app_number }})
          APP_DIR="apps/app${APP_NUM}"
          cd "$APP_DIR"
          echo "Cleaning build for: $APP_DIR"
          flutter clean
          flutter pub get

      - name: ðŸ—ï¸ Build AAB
        run: |
          APP_NUM=$(printf "%02d" ${{ github.event.inputs.app_number }})
          APP_DIR="apps/app${APP_NUM}"
          cd "$APP_DIR"
          echo "Building release AAB for: $APP_DIR"
          echo "Package: org.gloven.app${APP_NUM}"
          flutter build appbundle --release --verbose
        continue-on-error: false

      - name: âœ… Verify AAB file
        run: |
          APP_NUM=$(printf "%02d" ${{ github.event.inputs.app_number }})
          APP_DIR="apps/app${APP_NUM}"
          AAB_FILE="$APP_DIR/build/app/outputs/bundle/release/app-release.aab"
          
          if [ -f "$AAB_FILE" ]; then
            echo "âœ… AAB file created successfully!"
            echo "Location: $AAB_FILE"
            ls -lh "$AAB_FILE"
            echo "File size: $(du -h "$AAB_FILE" | cut -f1)"
            echo ""
            echo "Checking AAB file type..."
            file "$AAB_FILE"
            
            # Check if AAB is valid
            if file "$AAB_FILE" | grep -q "Zip archive"; then
              echo "âœ… AAB is a valid ZIP archive"
            else
              echo "âš ï¸  Warning: AAB may not be a valid ZIP archive"
            fi
          else
            echo "âŒ Error: AAB file not found at $AAB_FILE"
            echo "Listing build directory contents:"
            find "$APP_DIR/build" -type f -name "*.aab" 2>/dev/null || echo "No AAB files found"
            ls -la "$APP_DIR/build/app/outputs/bundle/release/" || true
            exit 1
          fi

      - name: ðŸ“¤ Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: app${{ github.event.inputs.app_number }}-aab
          path: apps/app${{ github.event.inputs.app_number }}/build/app/outputs/bundle/release/app-release.aab
          retention-days: 90
          if-no-files-found: error

      - name: ðŸ“Š Build summary
        if: success()
        run: |
          APP_NUM=$(printf "%02d" ${{ github.event.inputs.app_number }})
          echo "## âœ… Build Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### App Details" >> $GITHUB_STEP_SUMMARY
          echo "- **App Number**: ${{ github.event.inputs.app_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Package**: org.gloven.app${APP_NUM}" >> $GITHUB_STEP_SUMMARY
          echo "- **AAB File**: app-release.aab" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Download" >> $GITHUB_STEP_SUMMARY
          echo "Download the artifact **app${APP_NUM}-aab** from the Actions tab." >> $GITHUB_STEP_SUMMARY

