name: ðŸ§ª Test Build App01

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'apps/app01/**'
      - '.github/workflows/build-test-app.yml'

jobs:
  test-build-app01:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: â˜• Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ“± Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.5'
          channel: 'stable'
          cache: true

      - name: ðŸ©º Flutter doctor
        run: flutter doctor -v

      - name: ðŸ“¦ Install dependencies
        run: |
          cd apps/app01
          flutter pub get

      - name: ðŸ” Setup Android signing
        run: |
          APP_DIR="apps/app01"
          echo "Setting up signing for: $APP_DIR"
          
          # Ensure android directory exists
          mkdir -p $APP_DIR/android
          
          # Check if secrets are available
          if [ -z "${{ secrets.KEYSTORE_BASE64 }}" ]; then
            echo "âŒ Error: KEYSTORE_BASE64 secret is not set"
            exit 1
          fi
          
          # Decode base64 keystore from secret
          echo "Decoding keystore..."
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > $APP_DIR/android/gloven-keystore.jks
          chmod 600 $APP_DIR/android/gloven-keystore.jks
          
          # Create key.properties in android/ directory
          # build.gradle.kts uses rootProject.file("key.properties") which looks in android/
          echo "Creating key.properties..."
          cat > $APP_DIR/android/key.properties << EOF
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=gloven-keystore.jks
          EOF
          
          # Verify keystore file
          echo "âœ… Verifying keystore..."
          if [ -f "$APP_DIR/android/gloven-keystore.jks" ]; then
            echo "âœ… Keystore file created successfully"
            ls -lh $APP_DIR/android/gloven-keystore.jks
            file $APP_DIR/android/gloven-keystore.jks
          else
            echo "âŒ Error: Keystore file not found at $APP_DIR/android/gloven-keystore.jks"
            exit 1
          fi
          
          # Verify key.properties file
          echo "âœ… Verifying key.properties..."
          if [ -f "$APP_DIR/android/key.properties" ]; then
            echo "âœ… key.properties created successfully"
            echo "Contents (passwords masked):"
            cat $APP_DIR/android/key.properties | sed 's/password=.*/password=***/'
            echo ""
            echo "Full path: $(realpath $APP_DIR/android/key.properties)"
          else
            echo "âŒ Error: key.properties not found at $APP_DIR/android/key.properties"
            exit 1
          fi
          
          # Verify build.gradle.kts references key.properties correctly
          echo "âœ… Checking build.gradle.kts configuration..."
          if grep -q 'rootProject.file("key.properties")' $APP_DIR/android/app/build.gradle.kts; then
            echo "âœ… build.gradle.kts correctly references key.properties"
          else
            echo "âš ï¸  Warning: build.gradle.kts may not reference key.properties correctly"
          fi

      - name: ðŸ§¹ Clean build
        run: |
          cd apps/app01
          flutter clean
          flutter pub get

      - name: ðŸ—ï¸ Build AAB
        run: |
          cd apps/app01
          echo "Building release AAB..."
          flutter build appbundle --release --verbose
        continue-on-error: false

      - name: âœ… Verify AAB file
        run: |
          AAB_FILE="apps/app01/build/app/outputs/bundle/release/app-release.aab"
          if [ -f "$AAB_FILE" ]; then
            echo "âœ… AAB file created successfully!"
            echo "Location: $AAB_FILE"
            ls -lh "$AAB_FILE"
            echo "File size: $(du -h "$AAB_FILE" | cut -f1)"
            echo ""
            echo "Checking AAB file type..."
            file "$AAB_FILE"
          else
            echo "âŒ Error: AAB file not found at $AAB_FILE"
            echo "Listing build directory contents:"
            ls -la apps/app01/build/app/outputs/bundle/release/ || true
            exit 1
          fi

      - name: ðŸ“¤ Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: app01-number-slide-puzzle-aab
          path: apps/app01/build/app/outputs/bundle/release/app-release.aab
          retention-days: 90
          if-no-files-found: error

      - name: ðŸ“Š Build summary
        if: success()
        run: |
          echo "## âœ… Build Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### App Details" >> $GITHUB_STEP_SUMMARY
          echo "- **App**: app01 - Number Slide Puzzle" >> $GITHUB_STEP_SUMMARY
          echo "- **Package**: org.gloven.app01" >> $GITHUB_STEP_SUMMARY
          echo "- **AAB File**: app-release.aab" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow**: Test Build App01" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the artifact from the Actions tab" >> $GITHUB_STEP_SUMMARY
          echo "2. Upload to Google Play Console" >> $GITHUB_STEP_SUMMARY
          echo "3. Test the signed AAB file" >> $GITHUB_STEP_SUMMARY

