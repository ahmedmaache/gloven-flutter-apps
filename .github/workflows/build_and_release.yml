name: Build and Release Flutter Apps

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      app_name:
        description: 'Specific app name to build (e.g., app01) or "all"'
        required: true
        default: 'all'

jobs:
  build-apps:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Decode Keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          if [ -z "$KEYSTORE_BASE64" ]; then
            echo "‚ùå KEYSTORE_BASE64 secret is missing!"
            exit 1
          fi
          echo "$KEYSTORE_BASE64" | base64 --decode > gloven-keystore.jks

      - name: Build Apps
        env:
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: |
          mkdir -p signed_aabs
          
          APP_NAME_INPUT="${{ github.event.inputs.app_name }}"
          if [ -z "$APP_NAME_INPUT" ]; then
            if [ "${{ github.event_name }}" = "push" ]; then
              APP_NAME_INPUT="app01" 
              echo "‚ö†Ô∏è Triggered by push. Testing with $APP_NAME_INPUT."
            else
              APP_NAME_INPUT="all"
            fi
          fi

          target_apps=""
          if [ "$APP_NAME_INPUT" = "all" ]; then
             target_apps="apps/*"
          else
             target_apps="apps/$APP_NAME_INPUT"
          fi
          
          for app_dir in $target_apps; do
            if [ -d "$app_dir" ]; then
              app_name=$(basename "$app_dir")
              if [ ! -d "$app_dir/android" ]; then continue; fi

              echo "üöÄ Patching and Building $app_name..."
              
              # Standardize build file (Inject signing directly into buildTypes as requested)
              # This handles both KTS and Groovy
              python3 -c "
import sys, re, os
path = ''
gradle_files = [f'$app_dir/android/app/build.gradle.kts', f'$app_dir/android/app/build.gradle']
for f in gradle_files:
    if os.path.exists(f): 
        path = f
        break
if not path: sys.exit(0)

is_kts = path.endswith('.kts')
key_alias = '$KEY_ALIAS'
key_pass = '$KEY_PASSWORD'
store_pass = '$STORE_PASSWORD'
# Path from android/app to root
keystore_path = '../../gloven-keystore.jks'

content = open(path).read()

# 1. Remove any existing signingConfigs block to avoid conflicts
content = re.sub(r'signingConfigs\s*\{.*?\}', '', content, flags=re.DOTALL)

# 2. Remove any existing signingConfig = ... line inside release block
content = re.sub(r'signingConfig\s*=\s*signingConfigs\..*', '', content)
content = re.sub(r'signingConfig\s*signingConfigs\..*', '', content)

# 3. Inject configuration directly into the release buildType
if is_kts:
    patch = f'''
        release {{
            signingConfig = signingConfigs.create(\"releaseConfig\") {{
                keyAlias = \"{key_alias}\"
                keyPassword = \"{key_pass}\"
                storeFile = file(\"{keystore_path}\")
                storePassword = \"{store_pass}\"
            }}
    '''
else:
    patch = f'''
        release {{
            signingConfig signingConfigs.create(\"releaseConfig\") {{
                keyAlias \"{key_alias}\"
                keyPassword \"{key_pass}\"
                storeFile file(\"{keystore_path}\")
                storePassword \"{store_pass}\"
            }}
    '''

new_content = re.sub(r'release\s*\{', patch, content)
open(path, 'w').write(new_content)
print(f'‚úÖ Patched {os.path.basename(path)}')
"

              cd "$app_dir"
              flutter pub get
              flutter build appbundle --release --build-name=1.0.0 --build-number=${{ github.run_number }}
              
              AAB_OUT="build/app/outputs/bundle/release/app-release.aab"
              if [ -f "$AAB_OUT" ]; then
                cp "$AAB_OUT" "../../signed_aabs/${app_name}-release.aab"
                echo "‚úÖ Success: $app_name"
              else
                echo "‚ùå Failed: $app_name"
              fi
              
              cd ../..
            fi
          done

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: signed-aabs
          path: signed_aabs/*.aab
          retention-days: 5
