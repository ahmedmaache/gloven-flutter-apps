name: Build and Release Flutter Apps

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      app_name:
        description: 'Specific app name to build (e.g., app01) or "all"'
        required: true
        default: 'all'

jobs:
  build-apps:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Decode Keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          if [ -z "$KEYSTORE_BASE64" ]; then
            echo "‚ùå KEYSTORE_BASE64 secret is missing!"
            exit 1
          fi
          echo "$KEYSTORE_BASE64" | base64 --decode > gloven-keystore.jks

      - name: Build Apps
        env:
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: |
          mkdir -p signed_aabs
          
          APP_NAME_INPUT="${{ github.event.inputs.app_name }}"
          if [ -z "$APP_NAME_INPUT" ]; then
            if [ "${{ github.event_name }}" = "push" ]; then
              APP_NAME_INPUT="app01" 
              echo "‚ö†Ô∏è Triggered by push. Testing with $APP_NAME_INPUT."
            else
              APP_NAME_INPUT="all"
            fi
          fi

          # Standard key.properties for the workflow
          echo "storePassword=$STORE_PASSWORD" > key.properties
          echo "keyPassword=$KEY_PASSWORD" >> key.properties
          echo "keyAlias=$KEY_ALIAS" >> key.properties
          echo "storeFile=../../gloven-keystore.jks" >> key.properties
          
          target_apps=""
          if [ "$APP_NAME_INPUT" = "all" ]; then
             target_apps="apps/*"
          else
             target_apps="apps/$APP_NAME_INPUT"
          fi
          
          for app_dir in $target_apps; do
            if [ -d "$app_dir" ]; then
              app_name=$(basename "$app_dir")
              if [ ! -d "$app_dir/android" ]; then continue; fi

              echo "üöÄ Patching and Building $app_name..."
              
              # COMPREHENSIVE PATCH for build.gradle.kts
              # 1. Use maybeCreate for the release signing config
              # 2. Ensure we use the 'release' signingConfig in the release buildType
              kts_file="$app_dir/android/app/build.gradle.kts"
              if [ -f "$kts_file" ]; then
                # Replace create("release") or getByName("release") with maybeCreate("release")
                sed -i 's/create("release")/maybeCreate("release")/g' "$kts_file"
                sed -i 's/getByName("release")/maybeCreate("release")/g' "$kts_file"
                
                # Special fix for the buildType assignment line 
                # From: signingConfig = signingConfigs.maybeCreate("release")
                # To: signingConfig = signingConfigs.getByName("release") (Assignment must use getByName)
                sed -i 's/signingConfig = signingConfigs.maybeCreate("release")/signingConfig = signingConfigs.getByName("release")/g' "$kts_file"
                
                echo "üîß Applied robust patches to $app_name"
              fi

              cd "$app_dir"
              cp ../../key.properties android/key.properties || true
              
              flutter pub get
              flutter build appbundle --release --build-name=1.0.0 --build-number=${{ github.run_number }}
              
              AAB_OUT="build/app/outputs/bundle/release/app-release.aab"
              if [ -f "$AAB_OUT" ]; then
                cp "$AAB_OUT" "../../signed_aabs/${app_name}-release.aab"
                echo "‚úÖ Success: $app_name"
              else
                echo "‚ùå Failed: $app_name"
              fi
              
              cd ../..
            fi
          done

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: signed-aabs
          path: signed_aabs/*.aab
          retention-days: 5
